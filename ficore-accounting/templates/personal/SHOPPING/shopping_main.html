<!DOCTYPE html>
<html lang="{{ session.get('lang', 'en') }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ tool_title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind.css') }}">
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .flash-message { padding: 1rem; margin-bottom: 1rem; border-radius: 0.25rem; }
        .flash-success { background-color: #d4edda; color: #155724; }
        .flash-danger { background-color: #f8d7da; color: #721c24; }
        .flash-warning { background-color: #fff3cd; color: #856404; }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold mb-4">{{ tool_title }}</h1>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash-message flash-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="tabs mb-4">
            <button class="tab-button px-4 py-2 {% if active_tab == 'create-list' %}bg-blue-500 text-white{% else %}bg-gray-200{% endif %}" onclick="openTab('create-list')">{{ trans('shopping_create_list', default='Create List') }}</button>
            <button class="tab-button px-4 py-2 {% if active_tab == 'dashboard' %}bg-blue-500 text-white{% else %}bg-gray-200{% endif %}" onclick="openTab('dashboard')">{{ trans('shopping_dashboard', default='Dashboard') }}</button>
        </div>

        <div id="create-list" class="tab-content {% if active_tab == 'create-list' %}active{% endif %}">
            <h2 class="text-xl font-semibold mb-4">{{ trans('shopping_create_list', default='Create New Shopping List') }}</h2>
            <form method="POST" action="{{ url_for('personal.shopping.main', tab='create-list') }}">
                {{ list_form.hidden_tag() }}
                <input type="hidden" name="action" value="create_list">
                <div class="mb-4">
                    {{ list_form.name.label(class="block text-sm font-medium text-gray-700") }}
                    {{ list_form.name(class="mt-1 block w-full border-gray-300 rounded-md shadow-sm") }}
                    {% for error in list_form.name.errors %}
                        <span class="text-red-600 text-sm">{{ error }}</span>
                    {% endfor %}
                </div>
                <div class="mb-4">
                    {{ list_form.budget.label(class="block text-sm font-medium text-gray-700") }}
                    {{ list_form.budget(class="mt-1 block w-full border-gray-300 rounded-md shadow-sm") }}
                    {% for error in list_form.budget.errors %}
                        <span class="text-red-600 text-sm">{{ error }}</span>
                    {% endfor %}
                </div>
                {{ list_form.submit(class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600") }}
            </form>
        </div>

        <div id="dashboard" class="tab-content {% if active_tab == 'dashboard' %}active{% endif %}">
            <h2 class="text-xl font-semibold mb-4">{{ trans('shopping_dashboard', default='Shopping List Dashboard') }}</h2>
            
            {% if latest_list.id %}
                <div class="mb-4">
                    <h3 class="text-lg font-medium">{{ trans('shopping_latest_list', default='Latest Shopping List') }}</h3>
                    <p><strong>{{ trans('general_list_name', default='List Name') }}:</strong> {{ latest_list.name }}</p>
                    <p><strong>{{ trans('general_budget', default='Budget') }}:</strong> {{ latest_list.budget }}</p>
                    <p><strong>{{ trans('general_total_spent', default='Total Spent') }}:</strong> {{ latest_list.total_spent }}</p>
                    <p><strong>{{ trans('general_status', default='Status') }}:</strong> {{ trans(latest_list.status, default=latest_list.status) }}</p>
                    <p><strong>{{ trans('general_collaborators', default='Collaborators') }}:</strong> {{ latest_list.collaborators|join(', ') or 'None' }}</p>
                    <p><strong>{{ trans('general_date', default='Created At') }}:</strong> {{ latest_list.created_at }}</p>
                    <div class="mt-2">
                        <a href="{{ url_for('personal.shopping.export_list_pdf', list_id=latest_list.id) }}" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">{{ trans('shopping_export_pdf', default='Export to PDF') }}</a>
                        <form method="POST" action="{{ url_for('personal.shopping.main', tab='dashboard') }}" class="inline">
                            <input type="hidden" name="action" value="delete_list">
                            <input type="hidden" name="list_id" value="{{ latest_list.id }}">
                            {{ list_form.csrf_token }}
                            <button type="submit" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">{{ trans('shopping_delete_list', default='Delete List') }}</button>
                        </form>
                    </div>
                </div>

                <div class="mb-4">
                    <h3 class="text-lg font-medium">{{ trans('shopping_add_item', default='Add Item to List') }}</h3>
                    {% if latest_list.id %}
                    <form method="POST" action="{{ url_for('personal.shopping.main', tab='dashboard') }}">
                        {{ item_form.hidden_tag() }}
                        <input type="hidden" name="action" value="add_item">
                        <input type="hidden" name="list_id" value="{{ latest_list.id }}">
                        <div class="mb-4">
                            {{ item_form.name.label(class="block text-sm font-medium text-gray-700") }}
                            {{ item_form.name(class="mt-1 block w-full border-gray-300 rounded-md shadow-sm") }}
                            {% for error in item_form.name.errors %}
                                <span class="text-red-600 text-sm">{{ error }}</span>
                            {% endfor %}
                        </div>
                        <div class="mb-4">
                            {{ item_form.quantity.label(class="block text-sm font-medium text-gray-700") }}
                            {{ item_form.quantity(class="mt-1 block w-full border-gray-300 rounded-md shadow-sm") }}
                            {% for error in item_form.quantity.errors %}
                                <span class="text-red-600 text-sm">{{ error }}</span>
                            {% endfor %}
                        </div>
                        <div class="mb-4">
                            {{ item_form.price.label(class="block text-sm font-medium text-gray-700") }}
                            {{ item_form.price(class="mt-1 block w-full border-gray-300 rounded-md shadow-sm") }}
                            {% for error in item_form.price.errors %}
                                <span class="text-red-600 text-sm">{{ error }}</span>
                            {% endfor %}
                        </div>
                        <div class="mb-4">
                            {{ item_form.store.label(class="block text-sm font-medium text-gray-700") }}
                            {{ item_form.store(class="mt-1 block w-full border-gray-300 rounded-md shadow-sm") }}
                            {% for error in item_form.store.errors %}
                                <span class="text-red-600 text-sm">{{ error }}</span>
                            {% endfor %}
                        </div>
                        <div class="mb-4">
                            {{ item_form.category.label(class="block text-sm font-medium text-gray-700") }}
                            {{ item_form.category(class="mt-1 block w-full border-gray-300 rounded-md shadow-sm") }}
                            {% for error in item_form.category.errors %}
                                <span class="text-red-600 text-sm">{{ error }}</span>
                            {% endfor %}
                        </div>
                        <div class="mb-4">
                            {{ item_form.status.label(class="block text-sm font-medium text-gray-700") }}
                            {{ item_form.status(class="mt-1 block w-full border-gray-300 rounded-md shadow-sm") }}
                            {% for error in item_form.status.errors %}
                                <span class="text-red-600 text-sm">{{ error }}</span>
                            {% endfor %}
                        </div>
                        <div class="mb-4">
                            {{ item_form.frequency.label(class="block text-sm font-medium text-gray-700") }}
                            {{ item_form.frequency(class="mt-1 block w-full border-gray-300 rounded-md shadow-sm") }}
                            {% for error in item_form.frequency.errors %}
                                <span class="text-red-600 text-sm">{{ error }}</span>
                            {% endfor %}
                        </div>
                        {{ item_form.submit(class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600") }}
                    </form>
                    {% else %}
                        <p>{{ trans('shopping_no_list_selected', default='No list selected to add items.') }}</p>
                    {% endif %}
                </div>

                <div class="mb-4">
                    <h3 class="text-lg font-medium">{{ trans('shopping_share_list', default='Share List') }}</h3>
                    {% if latest_list.id %}
                    <form method="POST" action="{{ url_for('personal.shopping.main', tab='dashboard') }}">
                        {{ share_form.hidden_tag() }}
                        <input type="hidden" name="action" value="share_list">
                        <input type="hidden" name="list_id" value="{{ latest_list.id }}">
                        <div class="mb-4">
                            {{ share_form.email.label(class="block text-sm font-medium text-gray-700") }}
                            {{ share_form.email(class="mt-1 block w-full border-gray-300 rounded-md shadow-sm") }}
                            {% for error in share_form.email.errors %}
                                <span class="text-red-600 text-sm">{{ error }}</span>
                            {% endfor %}
                        </div>
                        {{ share_form.submit(class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600") }}
                    </form>
                    {% else %}
                        <p>{{ trans('shopping_no_list_selected', default='No list selected to share.') }}</p>
                    {% endif %}
                </div>

                <div class="mb-4">
                    <h3 class="text-lg font-medium">{{ trans('shopping_items', default='Items') }}</h3>
                    {% if items %}
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-200">
                                    <th class="border p-2">{{ trans('general_item_name', default='Item Name') }}</th>
                                    <th class="border p-2">{{ trans('general_quantity', default='Quantity') }}</th>
                                    <th class="border p-2">{{ trans('general_price', default='Price') }}</th>
                                    <th class="border p-2">{{ trans('general_category', default='Category') }}</th>
                                    <th class="border p-2">{{ trans('general_status', default='Status') }}</th>
                                    <th class="border p-2">{{ trans('general_store', default='Store') }}</th>
                                    <th class="border p-2">{{ trans('general_frequency', default='Frequency') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in items %}
                                    <tr>
                                        <td class="border p-2">{{ item.name }}</td>
                                        <td class="border p-2">{{ item.quantity }}</td>
                                        <td class="border p-2">{{ item.price }}</td>
                                        <td class="border p-2">{{ trans(item.category, default=item.category) }}</td>
                                        <td class="border p-2">{{ trans(item.status, default=item.status) }}</td>
                                        <td class="border p-2">{{ item.store }}</td>
                                        <td class="border p-2">{{ item.frequency }} {{ trans('general_days', default='days') }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p>{{ trans('shopping_no_items', default='No items in this list.') }}</p>
                    {% endif %}
                </div>
            {% else %}
                <p>{{ trans('shopping_no_lists', default='No shopping lists found. Create one to get started.') }}</p>
            {% endif %}

            <div class="mb-4">
                <h3 class="text-lg font-medium">{{ trans('shopping_all_lists', default='All Shopping Lists') }}</h3>
                {% if lists %}
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="border p-2">{{ trans('general_list_name', default='List Name') }}</th>
                                <th class="border p-2">{{ trans('general_budget', default='Budget') }}</th>
                                <th class="border p-2">{{ trans('general_total_spent', default='Total Spent') }}</th>
                                <th class="border p-2">{{ trans('general_status', default='Status') }}</th>
                                <th class="border p-2">{{ trans('general_actions', default='Actions') }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for list_id, lst in lists.items() %}
                                <tr>
                                    <td class="border p-2">{{ lst.name }}</td>
                                    <td class="border p-2">{{ lst.budget }}</td>
                                    <td class="border p-2">{{ lst.total_spent }}</td>
                                    <td class="border p-2">{{ trans(lst.status, default=lst.status) }}</td>
                                    <td class="border p-2">
                                        <a href="{{ url_for('personal.shopping.export_list_pdf', list_id=lst.id) }}" class="text-green-500 hover:underline">{{ trans('shopping_export_pdf', default='Export') }}</a>
                                        <form method="POST" action="{{ url_for('personal.shopping.main', tab='dashboard') }}" class="inline">
                                            <input type="hidden" name="action" value="delete_list">
                                            <input type="hidden" name="list_id" value="{{ lst.id }}">
                                            {{ list_form.csrf_token }}
                                            <button type="submit" class="text-red-500 hover:underline">{{ trans('shopping_delete_list', default='Delete') }}</button>
                                        </form>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p>{{ trans('shopping_no_lists', default='No shopping lists found.') }}</p>
                {% endif %}
            </div>

            {% if categories %}
                <div class="mb-4">
                    <h3 class="text-lg font-medium">{{ trans('shopping_categories', default='Spending by Category') }}</h3>
                    <ul>
                        {% for category, amount in categories.items() %}
                            <li>{{ category }}: {{ format_currency(amount) }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

            {% if tips %}
                <div class="mb-4">
                    <h3 class="text-lg font-medium">{{ trans('shopping_tips', default='Shopping Tips') }}</h3>
                    <ul class="list-disc pl-5">
                        {% for tip in tips %}
                            <li>{{ tip }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

            {% if insights %}
                <div class="mb-4">
                    <h3 class="text-lg font-medium">{{ trans('shopping_insights', default='Insights') }}</h3>
                    <ul class="list-disc pl-5">
                        {% for insight in insights %}
                            <li>{{ insight }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
        </div>
    </div>

    <script>
        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('bg-blue-500', 'text-white'));
            document.querySelectorAll('.tab-button').forEach(button => button.classList.add('bg-gray-200'));
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`button[onclick="openTab('${tabName}')"]`).classList.add('bg-blue-500', 'text-white');
            window.history.pushState({}, '', '{{ url_for("personal.shopping.main") }}?tab=' + tabName);
        }
    </script>
</body>
</html>
