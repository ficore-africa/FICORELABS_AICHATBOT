<!DOCTYPE html>
<html lang="{{ session.get('lang', 'en') }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ tool_title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind.css') }}">
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .flash-message { padding: 1rem; margin-bottom: 1rem; border-radius: 0.25rem; }
        .flash-success { background-color: #d4edda; color: #155724; }
        .flash-danger { background-color: #f8d7da; color: #721c24; }
        .flash-warning { background-color: #fff3cd; color: #856404; }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold mb-4">{{ tool_title }}</h1>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash-message flash-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="tabs mb-4">
            <button class="tab-button px-4 py-2 {% if active_tab == 'create-order' %}bg-blue-500 text-white{% else %}bg-gray-200{% endif %}" onclick="openTab('create-order')">{{ trans('food_order_create', default='Create Food Order') }}</button>
            <button class="tab-button px-4 py-2 {% if active_tab == 'dashboard' %}bg-blue-500 text-white{% else %}bg-gray-200{% endif %}" onclick="openTab('dashboard')">{{ trans('general_view_all', default='View All') }}</button>
        </div>

        <div id="create-order" class="tab-content {% if active_tab == 'create-order' %}active{% endif %}">
            <h2 class="text-xl font-semibold mb-4">{{ trans('food_order_create', default='Create New Food Order') }}</h2>
            <form method="POST" action="{{ url_for('personal.food_order.main', tab='create-order') }}">
                {{ order_form.hidden_tag() }}
                <input type="hidden" name="action" value="create_order">
                <div class="mb-4">
                    {{ order_form.name.label(class="block text-sm font-medium text-gray-700") }}
                    {{ order_form.name(class="mt-1 block w-full border-gray-300 rounded-md shadow-sm") }}
                    {% for error in order_form.name.errors %}
                        <span class="text-red-600 text-sm">{{ error }}</span>
                    {% endfor %}
                </div>
                <div class="mb-4">
                    {{ order_form.vendor.label(class="block text-sm font-medium text-gray-700") }}
                    {{ order_form.vendor(class="mt-1 block w-full border-gray-300 rounded-md shadow-sm") }}
                    {% for error in order_form.vendor.errors %}
                        <span class="text-red-600 text-sm">{{ error }}</span>
                    {% endfor %}
                </div>
                <div class="mb-4">
                    {{ order_form.phone.label(class="block text-sm font-medium text-gray-700") }}
                    {{ order_form.phone(class="mt-1 block w-full border-gray-300 rounded-md shadow-sm") }}
                    {% for error in order_form.phone.errors %}
                        <span class="text-red-600 text-sm">{{ error }}</span>
                    {% endfor %}
                </div>
                <div class="mb-4">
                    {{ order_form.location.label(class="block text-sm font-medium text-gray-700") }}
                    {{ order_form.location(class="mt-1 block w-full border-gray-300 rounded-md shadow-sm") }}
                    <button type="button" class="mt-2 bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300" onclick="getUserLocation()">{{ trans('food_order_auto_detect', default='Auto Detect Location') }}</button>
                    {% for error in order_form.location.errors %}
                        <span class="text-red-600 text-sm">{{ error }}</span>
                    {% endfor %}
                </div>
                {{ order_form.submit(class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600") }}
            </form>
        </div>

        <div id="dashboard" class="tab-content {% if active_tab == 'dashboard' %}active{% endif %}">
            <h2 class="text-xl font-semibold mb-4">{{ trans('food_order_dashboard', default='Food Order Dashboard') }}</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div class="bg-white p-4 rounded-md shadow">
                    <h3 class="text-lg font-medium">{{ trans('food_order_total_orders', default='Total Orders') }}</h3>
                    <p>{{ total_orders }}</p>
                </div>
                <div class="bg-white p-4 rounded-md shadow">
                    <h3 class="text-lg font-medium">{{ trans('food_order_total_spent', default='Total Spent') }}</h3>
                    <p>{{ total_spent }}</p>
                </div>
                <div class="bg-white p-4 rounded-md shadow">
                    <h3 class="text-lg font-medium">{{ trans('food_order_pending', default='Pending Orders') }}</h3>
                    <p>{{ pending_orders }}</p>
                </div>
            </div>

            {% if latest_order.id %}
                <div class="mb-4">
                    <h3 class="text-lg font-medium">{{ trans('food_order_latest_order', default='Latest Food Order') }}</h3>
                    <p><strong>{{ trans('food_order_name', default='Order Name') }}:</strong> {{ latest_order.name }}</p>
                    <p><strong>{{ trans('food_order_vendor', default='Vendor') }}:</strong> {{ latest_order.vendor }}</p>
                    <p><strong>{{ trans('food_order_phone', default='Phone') }}:</strong> {{ latest_order.phone }}</p>
                    <p><strong>{{ trans('food_order_location', default='Location') }}:</strong> {{ latest_order.location }}</p>
                    <p><strong>{{ trans('food_order_total_cost', default='Total Cost') }}:</strong> {{ latest_order.total_cost }}</p>
                    <p><strong>{{ trans('general_status', default='Status') }}:</strong> {{ trans(latest_order.status, default=latest_order.status) }}</p>
                    <p><strong>{{ trans('general_date', default='Created At') }}:</strong> {{ latest_order.created_at }}</p>
                    <div class="mt-2">
                        <a href="{{ url_for('personal.food_order.export_order_pdf', order_id=latest_order.id) }}" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">{{ trans('food_order_export_pdf', default='Export to PDF') }}</a>
                        <form method="POST" action="{{ url_for('personal.food_order.main', tab='dashboard') }}" class="inline">
                            <input type="hidden" name="action" value="delete_order">
                            <input type="hidden" name="order_id" value="{{ latest_order.id }}">
                            {{ order_form.csrf_token }}
                            <button type="submit" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">{{ trans('food_order_delete', default='Delete Order') }}</button>
                        </form>
                        <form method="POST" action="{{ url_for('personal.food_order.reorder', order_id=latest_order.id) }}" class="inline">
                            {{ order_form.csrf_token }}
                            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">{{ trans('food_order_reorder', default='Reorder') }}</button>
                        </form>
                    </div>
                </div>

                <div class="mb-4">
                    <h3 class="text-lg font-medium">{{ trans('food_order_add_item', default='Add Item to Order') }}</h3>
                    <form method="POST" action="{{ url_for('personal.food_order.main', tab='dashboard') }}">
                        {{ item_form.hidden_tag() }}
                        <input type="hidden" name="action" value="add_item">
                        <input type="hidden" name="order_id" value="{{ latest_order.id }}">
                        <div class="mb-4">
                            {{ item_form.name.label(class="block text-sm font-medium text-gray-700") }}
                            {{ item_form.name(class="mt-1 block w-full border-gray-300 rounded-md shadow-sm") }}
                            {% for error in item_form.name.errors %}
                                <span class="text-red-600 text-sm">{{ error }}</span>
                            {% endfor %}
                        </div>
                        <div class="mb-4">
                            {{ item_form.quantity.label(class="block text-sm font-medium text-gray-700") }}
                            {{ item_form.quantity(class="mt-1 block w-full border-gray-300 rounded-md shadow-sm") }}
                            {% for error in item_form.quantity.errors %}
                                <span class="text-red-600 text-sm">{{ error }}</span>
                            {% endfor %}
                        </div>
                        <div class="mb-4">
                            {{ item_form.price.label(class="block text-sm font-medium text-gray-700") }}
                            {{ item_form.price(class="mt-1 block w-full border-gray-300 rounded-md shadow-sm") }}
                            {% for error in item_form.price.errors %}
                                <span class="text-red-600 text-sm">{{ error }}</span>
                            {% endfor %}
                        </div>
                        <div class="mb-4">
                            {{ item_form.notes.label(class="block text-sm font-medium text-gray-700") }}
                            {{ item_form.notes(class="mt-1 block w-full border-gray-300 rounded-md shadow-sm") }}
                            {% for error in item_form.notes.errors %}
                                <span class="text-red-600 text-sm">{{ error }}</span>
                            {% endfor %}
                        </div>
                        {{ item_form.submit(class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600") }}
                    </form>
                </div>

                <div class="mb-4">
                    <h3 class="text-lg font-medium">{{ trans('food_order_items', default='Items') }}</h3>
                    {% if items %}
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-200">
                                    <th class="border p-2">{{ trans('food_order_item_name', default='Item Name') }}</th>
                                    <th class="border p-2">{{ trans('food_order_quantity', default='Quantity') }}</th>
                                    <th class="border p-2">{{ trans('food_order_price', default='Price') }}</th>
                                    <th class="border p-2">{{ trans('food_order_notes', default='Notes') }}</th>
                                    <th class="border p-2">{{ trans('food_order_category', default='Category') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in items %}
                                    <tr>
                                        <td class="border p-2">{{ item.name }}</td>
                                        <td class="border p-2">
                                            <input type="number" class="w-full border-gray-300 rounded-md" value="{{ item.quantity }}" min="1" onchange="updateFoodOrderItem('{{ item.item_id }}', 'quantity', this.value)">
                                        </td>
                                        <td class="border p-2">
                                            <input type="number" class="w-full border-gray-300 rounded-md" value="{{ item.price_raw }}" min="0" step="0.01" onchange="updateFoodOrderItem('{{ item.item_id }}', 'price', this.value)">
                                        </td>
                                        <td class="border p-2">
                                            <input type="text" class="w-full border-gray-300 rounded-md" value="{{ item.notes }}" onchange="updateFoodOrderItem('{{ item.item_id }}', 'notes', this.value)">
                                        </td>
                                        <td class="border p-2">{{ trans(item.category, default=item.category) }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p>{{ trans('food_order_no_items', default='No items in this order.') }}</p>
                    {% endif %}
                </div>
            {% else %}
                <p>{{ trans('food_order_no_orders', default='No food orders found. Create one to get started.') }}</p>
            {% endif %}

            <div class="mb-4">
                <h3 class="text-lg font-medium">{{ trans('food_order_all_orders', default='All Food Orders') }}</h3>
                {% if orders %}
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="border p-2">{{ trans('food_order_name', default='Order Name') }}</th>
                                <th class="border p-2">{{ trans('food_order_vendor', default='Vendor') }}</th>
                                <th class="border p-2">{{ trans('food_order_total_cost', default='Total Cost') }}</th>
                                <th class="border p-2">{{ trans('general_status', default='Status') }}</th>
                                <th class="border p-2">{{ trans('general_actions', default='Actions') }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order_id, order in orders.items() %}
                                <tr>
                                    <td class="border p-2">{{ order.name }}</td>
                                    <td class="border p-2">{{ order.vendor }}</td>
                                    <td class="border p-2">{{ order.total_cost }}</td>
                                    <td class="border p-2">{{ trans(order.status, default=order.status) }}</td>
                                    <td class="border p-2">
                                        <a href="{{ url_for('personal.food_order.export_order_pdf', order_id=order.id) }}" class="text-green-500 hover:underline">{{ trans('food_order_export_pdf', default='Export') }}</a>
                                        <form method="POST" action="{{ url_for('personal.food_order.main', tab='dashboard') }}" class="inline">
                                            <input type="hidden" name="action" value="delete_order">
                                            <input type="hidden" name="order_id" value="{{ order.id }}">
                                            {{ order_form.csrf_token }}
                                            <button type="submit" class="text-red-500 hover:underline">{{ trans('food_order_delete', default='Delete') }}</button>
                                        </form>
                                        <form method="POST" action="{{ url_for('personal.food_order.reorder', order_id=order.id) }}" class="inline">
                                            {{ order_form.csrf_token }}
                                            <button type="submit" class="text-blue-500 hover:underline">{{ trans('food_order_reorder', default='Reorder') }}</button>
                                        </form>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p>{{ trans('food_order_no_orders', default='No food orders found.') }}</p>
                {% endif %}
            </div>

            {% if categories %}
                <div class="mb-4">
                    <h3 class="text-lg font-medium">{{ trans('food_order_categories', default='Spending by Category') }}</h3>
                    <ul>
                        {% for category, amount in categories.items() %}
                            <li>{{ category }}: {{ format_currency(amount) }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

            {% if tips %}
                <div class="mb-4">
                    <h3 class="text-lg font-medium">{{ trans('food_order_tips', default='Food Order Tips') }}</h3>
                    <ul class="list-disc pl-5">
                        {% for tip in tips %}
                            <li>{{ tip }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

            {% if insights %}
                <div class="mb-4">
                    <h3 class="text-lg font-medium">{{ trans('food_order_insights', default='Insights') }}</h3>
                    <ul class="list-disc pl-5">
                        {% for insight in insights %}
                            <li>{{ insight }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
        </div>
    </div>

    <script>
        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('bg-blue-500', 'text-white'));
            document.querySelectorAll('.tab-button').forEach(button => button.classList.add('bg-gray-200'));
            document.querySelector(`#${tabName}`).classList.add('active');
            document.querySelector(`button[onclick="openTab('${tabName}')"]`).classList.add('bg-blue-500', 'text-white');
            window.history.pushState({}, '', '{{ url_for("personal.food_order.main") }}?tab=' + tabName);
        }

        async function getUserLocation() {
            try {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            const location = `${position.coords.latitude},${position.coords.longitude}`;
                            document.getElementById('{{ order_form.location.id }}').value = location;
                            const response = await fetch('{{ url_for("personal.food_order.get_nearest_vendor") }}?location=' + encodeURIComponent(location));
                            const data = await response.json();
                            if (data.vendor) {
                                document.getElementById('{{ order_form.vendor.id }}').value = data.vendor;
                            } else {
                                alert('{{ trans("food_order_no_vendors", default="No vendors found nearby") }}');
                            }
                        },
                        (error) => {
                            console.error('Error getting location:', error);
                            alert('{{ trans("food_order_location_error", default="Unable to auto-detect location. Please enter manually.") }}');
                        }
                    );
                } else {
                    alert('{{ trans("food_order_geolocation_unsupported", default="Geolocation is not supported by this browser.") }}');
                }
            } catch (error) {
                console.error('Error in getUserLocation:', error);
                alert('{{ trans("general_error", default="An error occurred") }}');
            }
        }

        async function updateFoodOrderItem(itemId, field, value) {
            try {
                {% if latest_order.id %}
                const response = await fetch('{{ url_for("personal.food_order.manage_items", order_id=latest_order.id) }}', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': '{{ order_form.csrf_token._value() }}'
                    },
                    body: JSON.stringify({ item_id: itemId, [field]: value })
                });
                const data = await response.json();
                if (data.error) {
                    alert(data.error);
                } else {
                    alert('{{ trans("food_order_item_updated", default="Item updated successfully") }}');
                    window.location.reload();
                }
                {% else %}
                alert('{{ trans("food_order_no_order", default="No order selected to update items.") }}');
                {% endif %}
            } catch (error) {
                console.error('Error updating food order item:', error);
                alert('{{ trans("general_error", default="An error occurred") }}');
            }
        }
    </script>
</body>
</html>
