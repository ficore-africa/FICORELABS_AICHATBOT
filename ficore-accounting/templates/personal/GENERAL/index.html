{% extends 'base.html' %}
{% block title %}{{ t('general_personal_finance_home', default='Personal Finance Home') | e }}{% endblock %}

{% block content %}
<div class="page-container">
    <noscript>
        <div style="padding: 1rem; background: #ffebee; border: 1px solid #ef5350; margin-bottom: 1rem;">
            {{ t('general_js_required', default='JavaScript is required to use this dashboard. Please enable it in your browser.') | e }}
        </div>
    </noscript>

    {% if current_user.is_authenticated %}
        <!-- Daily Tools -->
        <section class="section-card daily-tools">
            <h3 class="section-title">{{ t('general_daily_tools', default='Daily Tools') | e }}</h3>
            <div class="quick-actions">
                <a href="#" class="quick-action-card grocery-management text-decoration-none" data-bs-toggle="modal" data-bs-target="#groceryModal" aria-label="{{ t('grocery_management', default='Smart Grocery Planner') | e }}">
                    <i class="bi bi-cart action-icon text-info"></i>
                    <div class="action-label">{{ t('grocery_management', default='Smart Grocery Planner') | e }}</div>
                </a>
                <a href="#" class="quick-action-card food-order text-decoration-none" data-bs-toggle="modal" data-bs-target="#foodOrderModal" aria-label="{{ t('food_order', default='Food Order') | e }}">
                    <i class="bi bi-box-seam action-icon text-primary"></i>
                    <div class="action-label">{{ t('food_order', default='Food Order') | e }}</div>
                </a>
            </div>
        </section>

        <!-- Financial Snapshots -->
        <div class="section-card financial-snapshots">
            <h3 class="section-title">{{ t('general_snapshots', default='Financial Snapshots') | e }}</h3>
            <div class="summary-cards">
                <div class="summary-card budget-card">
                    <div class="card-header d-flex align-items-center gap-3">
                        <i class="bi bi-pie-chart card-icon text-primary"></i>
                        <span class="fw-bold">{{ t('budget_budget_status', default='Budget Status') | e }}</span>
                    </div>
                    <div class="card-amount mt-3" id="budgetStatus">
                        <span class="currency-symbol">₦</span>
                        <span class="amount-value" data-amount="0">0.00</span>
                    </div>
                    <div class="status-label" id="budgetStatusLabel"></div>
                </div>
                <div class="summary-card bills-card">
                    <div class="card-header d-flex align-items-center gap-3">
                        <i class="bi bi-receipt card-icon text-warning"></i>
                        <span class="fw-bold">{{ t('bill_upcoming_bills', default='Upcoming Bills') | e }}</span>
                    </div>
                    <div class="card-amount mt-3" id="upcomingBills">
                        <span class="currency-symbol">₦</span>
                        <span class="amount-value" data-amount="0">0.00</span>
                    </div>
                    <div class="status-label" id="billsStatusLabel"></div>
                </div>
            </div>
            <div class="mt-3 text-end">
                <button class="btn btn-link" onclick="toggleAmountVisibility()" data-bs-toggle="tooltip" data-bs-title="{{ t('general_toggle_visibility', default='Toggle amount visibility') | e }}">
                    <i id="visibilityIcon" class="bi bi-eye"></i>
                </button>
            </div>
        </div>

        <!-- Balance Overview -->
        <div class="section-card balance-overview">
            <h3 class="section-title">{{ t('general_balance_overview', default='Balance Overview') | e }}</h3>
            <div class="summary-cards">
                <div class="summary-card wallet-balance">
                    <div class="card-header d-flex align-items-center gap-3">
                        <i class="bi bi-wallet2 card-icon text-success"></i>
                        <span class="fw-bold">{{ t('general_ficore_credits', default='Ficore Credits') | e }}</span>
                    </div>
                    <div class="card-amount text-success mt-3" id="walletBalance">
                        <span class="currency-symbol">₦</span>
                        <span class="amount-value" data-amount="0">0.00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="section-card recent-activity">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="section-title mb-0">{{ t('general_recent_activity', default='Recent Activity') | e }}</h3>
                <a href="#" class="btn btn-link btn-sm p-0 text-decoration-none" id="viewAllActivities" onclick="toggleRecentActivities()">
                    {{ t('general_view_all', default='View All') | e }}
                </a>
            </div>
            <div id="recentActivityList">
                <div class="recent-activity-card">
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="bi bi-info-circle text-muted"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-description fw-semibold">{{ t('general_no_recent_activity', default='No recent activity') | e }}</div>
                            <div class="activity-time text-muted">{{ t('general_start_by_adding', default='Start by adding a budget or bill') | e }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifications -->
        <div class="section-card notifications">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="section-title mb-0">{{ t('general_notifications', default='Notifications') | e }}</h3>
                <span class="badge bg-primary rounded-pill" id="notificationCount">0</span>
            </div>
            <div id="notificationList">
                <div class="notification-card">
                    <div class="notification-item">
                        <div class="notification-icon">
                            <i class="bi bi-info-circle text-muted"></i>
                        </div>
                        <div class="notification-content">
                            <div class="notification-description fw-semibold">{{ t('general_no_notifications', default='No notifications') | e }}</div>
                            <div class="notification-time text-muted">{{ t('general_check_back_later', default='Check back later') | e }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Explore Features -->
        <div class="section-card explore-section">
            <h3 class="section-title">{{ t('general_explore_features', default='Explore Features') | e }}</h3>
            {% for feature in explore_features_for_template %}
            <a href="{{ feature.get('url', '#') | e }}" class="explore-card text-decoration-none" aria-label="{{ t(feature.get('label_key', ''), default=feature.get('label', 'Feature')) | e }}">
                <div class="explore-card-icon">
                    <i class="bi {{ feature.get('icon', 'bi-circle') | e }} text-primary"></i>
                </div>
                <div class="explore-card-text">
                    <h4>{{ t(feature.get('label_key', ''), default=feature.get('label', 'Feature')) | e }}</h4>
                    <p class="text-muted">{{ t(feature.get('description_key', ''), default=feature.get('description', 'Description not available')) | e }}</p>
                </div>
            </a>
            {% endfor %}
        </div>

        <!-- Grocery Planner Modal -->
        <div class="modal fade" id="groceryModal" tabindex="-1" aria-labelledby="groceryModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="groceryModalLabel">{{ t('grocery_shopping_planner', default='Smart Grocery Planner') | e }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <noscript>
                            <div style="padding: 1rem; background: #ffebee; border: 1px solid #ef5350;">
                                {{ t('grocery_js_required', default='JavaScript is required to use the Grocery Planner. Please enable it in your browser.') | e }}
                            </div>
                        </noscript>
                        <div id="grocery-planner-root"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t('general_close', default='Close') | e }}</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Food Order Modal -->
        <div class="modal fade" id="foodOrderModal" tabindex="-1" aria-labelledby="foodOrderModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="foodOrderModalLabel">{{ t('food_order', default='Food Order') | e }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <noscript>
                            <div style="padding: 1rem; background: #ffebee; border: 1px solid #ef5350;">
                                {{ t('food_order_js_required', default='JavaScript is required to use the Food Order feature. Please enable it in your browser.') | e }}
                            </div>
                        </noscript>
                        <div id="food-order-root"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t('general_close', default='Close') | e }}</button>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<style>
.spacer {
    margin: 1.5rem 0;
}
.notification-card, .recent-activity-card {
    border-bottom: 1px solid #e9ecef;
    padding: 0.75rem 0;
}
.notification-item, .activity-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}
.notification-icon, .activity-icon {
    font-size: 1.25rem;
}
.notification-content, .activity-content {
    flex-grow: 1;
}
.notification-description, .activity-description {
    font-size: 0.9rem;
    font-weight: 500;
}
.notification-time, .activity-time {
    font-size: 0.8rem;
}
.summary-card {
    padding: 0.75rem;
    border: 1px solid #e9ecef;
    border-radius: 0.25rem;
    margin-bottom: 0.5rem;
}
.card-header {
    font-size: 1rem;
}
.card-amount {
    font-size: 1.25rem;
    font-weight: 500;
}
.status-label {
    font-size: 0.8rem;
    font-weight: 500;
    margin-top: 0.25rem;
}
.grocery-item, .meal-plan-item, .suggestion-item, .food-order-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid #e9ecef;
}
.grocery-item select, .grocery-item input, .meal-plan-item input, .suggestion-item input, .food-order-item input {
    max-width: 100px;
}
</style>
{% endblock %}

{% block extra_scripts %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="{{ url_for('static', filename='js/grocery.js') }}"></script>
<script src="{{ url_for('static', filename='js/food-order.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(tooltipTriggerEl => {
        new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Debug icons
    document.querySelectorAll('.bi').forEach(icon => {
        if (!icon.className.includes('bi-')) {
            console.warn('Invalid or missing Bootstrap Icon class:', icon.className);
        }
    });

    // Debug navigation duplication
    const topNav = document.querySelector('.top-header');
    const bottomNav = document.querySelector('.bottom-nav');
    if (topNav && bottomNav) {
        const topNavItems = topNav.querySelectorAll('.nav-item');
        if (topNavItems.length > 0) {
            console.warn('Unexpected navigation items in top-header:', topNavItems);
        }
    }

    {% if current_user.is_authenticated %}
    // Load financial data, notifications, recent activity
    loadFinancialSummary();
    loadRecentActivity();
    loadNotifications();

    // Initialize grocery planner
    initGroceryPlanner();

    // Initialize food order
    initFoodOrder();

    // Check for Friday reminder
    const today = new Date();
    if (today.getDay() === 5) { // Friday
        setTimeout(() => {
            showToast(translations.friday_reminder, 'info');
        }, 2000);
    }

    // Offline support: Load cached data
    loadOfflineData();
    {% endif %}
});
</script>
{% endblock %}
