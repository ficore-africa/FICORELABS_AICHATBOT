{% extends 'base.html' %}
{% block title %}Personal Finance Home{% endblock %}

{% block content %}
<div class="page-container">
    <noscript>
        <div style="padding: 1rem; background: #ffebee; border: 1px solid #ef5350; margin-bottom: 1rem;">
            JavaScript is required to use this dashboard. Please enable it in your browser.
        </div>
    </noscript>

    {% if current_user.is_authenticated %}
        <!-- CSRF Token -->
        <meta name="csrf-token" content="{{ csrf_token() }}">

        <!-- Daily Tools -->
        <section class="section-card daily-tools">
            <h3 class="section-title">Popular Tools</h3>
            <div class="quick-actions">
                <a href="javascript:void(0)" class="quick-action-card grocery-management text-decoration-none" data-bs-toggle="modal" data-bs-target="#groceryModal" aria-label="Smart Grocery Planner">
                    <i class="bi bi-cart action-icon text-info"></i>
                    <div class="action-label">Smart Grocery Planner</div>
                </a>
                <a href="javascript:void(0)" class="quick-action-card food-order text-decoration-none" data-bs-toggle="modal" data-bs-target="#foodOrderModal" aria-label="Food Order">
                    <i class="bi bi-box-seam action-icon text-primary"></i>
                    <div class="action-label">Order Food</div>
                </a>
            </div>
        </section>

        <!-- Financial Snapshots -->
        <div class="section-card financial-snapshots">
            <h3 class="section-title">Financial Snapshots</h3>
            <div class="summary-cards">
                <div class="summary-card budget-card">
                    <div class="card-header d-flex align-items-center gap-3">
                        <i class="bi bi-pie-chart card-icon text-primary"></i>
                        <span class="fw-bold">Budget Status</span>
                    </div>
                    <div class="card-amount mt-3" id="budgetStatus">
                        <span class="currency-symbol">₦</span>
                        <span class="amount-value" data-amount="0">0.00</span>
                    </div>
                    <div class="status-label" id="budgetStatusLabel"></div>
                </div>
                <div class="summary-card bills-card">
                    <div class="card-header d-flex align-items-center gap-3">
                        <i class="bi bi-receipt card-icon text-warning"></i>
                        <span class="fw-bold">Upcoming Bills</span>
                    </div>
                    <div class="card-amount mt-3" id="upcomingBills">
                        <span class="currency-symbol">₦</span>
                        <span class="amount-value" data-amount="0">0.00</span>
                    </div>
                    <div class="status-label" id="billsStatusLabel"></div>
                </div>
                <div class="summary-card grocery-card">
                    <div class="card-header d-flex align-items-center gap-3">
                        <i class="bi bi-cart card-icon text-info"></i>
                        <span class="fw-bold">Grocery Spending</span>
                    </div>
                    <div class="card-amount mt-3" id="grocerySpending">
                        <span class="currency-symbol">₦</span>
                        <span class="amount-value" data-amount="0">0.00</span>
                    </div>
                    <div class="status-label" id="groceryStatusLabel"></div>
                </div>
                <div class="summary-card food-order-card">
                    <div class="card-header d-flex align-items-center gap-3">
                        <i class="bi bi-box-seam card-icon text-primary"></i>
                        <span class="fw-bold">Food Order Spending</span>
                    </div>
                    <div class="card-amount mt-3" id="foodOrderSpending">
                        <span class="currency-symbol">₦</span>
                        <span class="amount-value" data-amount="0">0.00</span>
                    </div>
                    <div class="status-label" id="foodOrderStatusLabel"></div>
                </div>
            </div>
            <div class="mt-3 text-end">
                <button class="btn btn-link" onclick="toggleAmountVisibility()" data-bs-toggle="tooltip" data-bs-title="Toggle amount visibility">
                    <i id="visibilityIcon" class="bi bi-eye"></i>
                </button>
            </div>
        </div>

        <!-- Balance Overview -->
        <div class="section-card balance-overview">
            <h3 class="section-title">Balance Overview</h3>
            <div class="summary-cards">
                <div class="summary-card wallet-balance">
                    <div class="card-header d-flex align-items-center gap-3">
                        <i class="bi bi-wallet2 card-icon text-success"></i>
                        <span class="fw-bold">Ficore Credits</span>
                    </div>
                    <div class="card-amount text-success mt-3" id="walletBalance">
                        <span class="currency-symbol">₦</span>
                        <span class="amount-value" data-amount="0">0.00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="section-card recent-activity">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="section-title mb-0">Recent Activity</h3>
                <a href="#" class="btn btn-link btn-sm p-0 text-decoration-none" id="viewAllActivities" onclick="toggleRecentActivities()">
                    View All
                </a>
            </div>
            <div id="recentActivityListLimited">
                <div class="recent-activity-card">
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="bi bi-info-circle text-muted"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-description fw-semibold">No recent activity</div>
                            <div class="activity-time text-muted">Start by adding a budget or bill</div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="recentActivityListFull" style="display: none;">
                <div class="recent-activity-card">
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="bi bi-info-circle text-muted"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-description fw-semibold">No recent activity</div>
                            <div class="activity-time text-muted">Start by adding a budget or bill</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifications -->
        <div class="section-card notifications">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="section-title mb-0">Notifications</h3>
                <span class="badge bg-primary rounded-pill" id="notificationCount">0</span>
            </div>
            <div id="notificationList">
                <div class="notification-card">
                    <div class="notification-item">
                        <div class="notification-icon">
                            <i class="bi bi-info-circle text-muted"></i>
                        </div>
                        <div class="notification-content">
                            <div class="notification-description fw-semibold">No notifications</div>
                            <div class="notification-time text-muted">Check back later</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Explore Features -->
        <div class="section-card explore-section">
            <h3 class="section-title">Explore Features</h3>
            {% for feature in explore_features_for_template %}
            <a href="{{ feature.get('url', '#') | e }}" class="explore-card text-decoration-none" aria-label="{{ t(feature.get('label_key', ''), default=feature.get('label', 'Feature')) | e }}">
                <div class="explore-card-icon">
                    <i class="bi {{ feature.get('icon', 'bi-circle') | e }} text-primary"></i>
                </div>
                <div class="explore-card-text">
                    <h4>{{ t(feature.get('label_key', ''), default=feature.get('label', 'Feature')) | e }}</h4>
                    <p class="text-muted">{{ t(feature.get('description_key', ''), default=feature.get('description', 'Description not available')) | e }}</p>
                </div>
            </a>
            {% endfor %}
        </div>

        <!-- Grocery Planner Modal -->
        <div class="modal fade" id="groceryModal" tabindex="-1" aria-labelledby="groceryModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="groceryModalLabel">Smart Grocery Planner</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <noscript>
                            <div style="padding: 1rem; background: #ffebee; border: 1px solid #ef5350;">
                                JavaScript is required to use the Grocery Planner. Please enable it in your browser.
                            </div>
                        </noscript>
                        <div id="grocery-planner-root"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Food Order Modal -->
        <div class="modal fade" id="foodOrderModal" tabindex="-1" aria-labelledby="foodOrderModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="foodOrderModalLabel">Food Order</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <noscript>
                            <div style="padding: 1rem; background: #ffebee; border: 1px solid #ef5350;">
                                JavaScript is required to use the Food Order feature. Please enable it in your browser.
                            </div>
                        </noscript>
                        <div id="food-order-root"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<style>
.spacer { margin: 1.5rem 0; }
.notification-card, .recent-activity-card, .food-order-item { border-bottom: 1px solid #e9ecef; padding: 0.75rem 0; }
.notification-item, .activity-item, .food-order-item { display: flex; align-items: center; gap: 0.75rem; }
.notification-icon, .activity-icon { font-size: 1.25rem; }
.notification-content, .activity-content { flex-grow: 1; }
.notification-description, .activity-description { font-size: 0.9rem; font-weight: 500; }
.notification-time, .activity-time { font-size: 0.8rem; }
.summary-card { padding: 0.75rem; border: 1px solid #e9ecef; border-radius: 0.25rem; margin-bottom: 0.5rem; }
.card-header { font-size: 1rem; }
.card-amount { font-size: 1.25rem; font-weight: 500; }
.status-label { font-size: 0.8rem; font-weight: 500; margin-top: 0.25rem; }
.grocery-item, .meal-plan-item, .suggestion-item, .food-order-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid #e9ecef; }
.grocery-item select, .grocery-item input, .meal-plan-item input, .suggestion-item input, .food-order-item input { max-width: 100px; }
</style>
{% endblock %}

{% block extra_scripts %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/static/js/translations.js"></script>
<script src="/static/js/grocery.js"></script>
<script src="/static/js/food-order.js"></script>
<script>
window.apiUrls = {
    budgetSummary: "/personal/summaries/budget/summary",
    billSummary: "/personal/summaries/bill/summary",
    grocerySummary: "/personal/summaries/grocery/summary",
    foodOrderSummary: "/personal/summaries/food_order/summary",
    ficoreBalance: "/personal/summaries/ficore_balance",
    recentActivity: "/personal/summaries/recent_activity",
    notifications: "/personal/summaries/notifications",
    manageGroceryLists: "/personal/grocery/lists",
    manageGroceryItems: "/personal/grocery/lists/{list_id}/items",
    shareGroceryList: "/personal/grocery/lists/{list_id}/share",
    manageGrocerySuggestions: "/personal/grocery/lists/{list_id}/suggestions",
    approveGrocerySuggestion: "/personal/grocery/lists/{list_id}/suggestions/{suggestion_id}/approve",
    manageMealPlans: "/personal/grocery/meal_plans",
    groceryPriceHistory: "/personal/grocery/price_history/{item_name}",
    predictiveSuggestions: "/personal/grocery/suggestions",
    manageFoodOrders: "/personal/food_order/manage_orders",
    manageFoodOrderItems: "/personal/food_order/manage_items/{order_id}",
    reorderFoodOrder: "/personal/food_order/reorder/{order_id}",
    getNearestVendor: "/personal/food_order/nearest_vendor"
};

let amountsVisible = true;
let isActivityExpanded = false;

function formatCurrency(value) {
    if (!value && value !== 0) return '0.00';
    value = parseFloat(value);
    if (isNaN(value)) return '0.00';
    return value.toLocaleString('en-NG', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function formatTimeAgo(timestamp) {
    const now = new Date();
    const time = new Date(timestamp);
    const diff = now - time;
    const minutes = Math.floor(diff / 60000);
    if (minutes < 1) return window.groceryTranslations.just_now;
    if (minutes < 60) return minutes + " " + window.groceryTranslations.minutes_ago;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return hours + " " + window.groceryTranslations.hours_ago;
    const days = Math.floor(hours / 24);
    return days + " " + window.groceryTranslations.days_ago;
}

function toggleAmountVisibility() {
    amountsVisible = !amountsVisible;
    const visibilityIcon = document.getElementById('visibilityIcon');
    visibilityIcon.classList.toggle('bi-eye', amountsVisible);
    visibilityIcon.classList.toggle('bi-eye-slash', !amountsVisible);
    document.querySelectorAll('.amount-value').forEach(el => {
        el.textContent = amountsVisible ? formatCurrency(el.dataset.amount) : '****';
    });
}

function toggleRecentActivities() {
    const limitedList = document.getElementById('recentActivityListLimited');
    const fullList = document.getElementById('recentActivityListFull');
    const viewAllButton = document.getElementById('viewAllActivities');
    
    isActivityExpanded = !isActivityExpanded;
    limitedList.style.display = isActivityExpanded ? 'none' : 'block';
    fullList.style.display = isActivityExpanded ? 'block' : 'none';
    viewAllButton.textContent = isActivityExpanded ? 'View Less' : 'View All';
}

function loadFinancialSummary() {
    fetch(window.apiUrls.budgetSummary)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Budget summary error:', data.error);
                showToast(window.groceryTranslations.not_found, 'danger');
                return;
            }
            const budgetStatus = document.getElementById('budgetStatus');
            budgetStatus.querySelector('.amount-value').dataset.amount = data.totalBudget;
            budgetStatus.querySelector('.amount-value').textContent = amountsVisible ? formatCurrency(data.totalBudget) : '****';
            document.getElementById('budgetStatusLabel').textContent = data.totalBudget >= 0 ? 'On Track' : 'Over Budget';
        })
        .catch(error => {
            console.error('Error loading budget summary:', error);
            showToast(window.groceryTranslations.not_found, 'danger');
        });

    fetch(window.apiUrls.billSummary)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Bill summary error:', data.error);
                showToast(window.groceryTranslations.not_found, 'danger');
                return;
            }
            const upcomingBills = document.getElementById('upcomingBills');
            upcomingBills.querySelector('.amount-value').dataset.amount = data.pending_amount;
            upcomingBills.querySelector('.amount-value').textContent = amountsVisible ? formatCurrency(data.pending_amount) : '****';
            document.getElementById('billsStatusLabel').textContent = data.overdue_amount > 0 ? 'Overdue' : 'On Time';
        })
        .catch(error => {
            console.error('Error loading bill summary:', error);
            showToast(window.groceryTranslations.not_found, 'danger');
        });

    fetch(window.apiUrls.grocerySummary)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Grocery summary error:', data.error);
                showToast(window.groceryTranslations.not_found, 'danger');
                return;
            }
            const grocerySpending = document.getElementById('grocerySpending');
            grocerySpending.querySelector('.amount-value').dataset.amount = data.total_grocery_spent;
            grocerySpending.querySelector('.amount-value').textContent = amountsVisible ? formatCurrency(data.total_grocery_spent) : '****';
            document.getElementById('groceryStatusLabel').textContent = data.total_grocery_spent <= data.total_grocery_budget ? 'Within Budget' : 'Over Budget';
        })
        .catch(error => {
            console.error('Error loading grocery summary:', error);
            showToast(window.groceryTranslations.not_found, 'danger');
        });

    fetch(window.apiUrls.foodOrderSummary)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Food order summary error:', data.error);
                showToast(window.foodOrderTranslations.not_found, 'danger');
                return;
            }
            const foodOrderSpending = document.getElementById('foodOrderSpending');
            foodOrderSpending.querySelector('.amount-value').dataset.amount = data.total_food_order_spent;
            foodOrderSpending.querySelector('.amount-value').textContent = amountsVisible ? formatCurrency(data.total_food_order_spent) : '****';
            document.getElementById('foodOrderStatusLabel').textContent = data.active_orders > 0 ? `${data.active_orders} Active Orders` : 'No Active Orders';
        })
        .catch(error => {
            console.error('Error loading food order summary:', error);
            showToast(window.foodOrderTranslations.not_found, 'danger');
        });

    fetch(window.apiUrls.ficoreBalance)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Ficore balance error:', data.error);
                showToast(window.groceryTranslations.not_found, 'danger');
                return;
            }
            const walletBalance = document.getElementById('walletBalance');
            walletBalance.querySelector('.amount-value').dataset.amount = data.balance;
            walletBalance.querySelector('.amount-value').textContent = amountsVisible ? formatCurrency(data.balance) : '****';
        })
        .catch(error => {
            console.error('Error loading ficore balance:', error);
            showToast(window.groceryTranslations.not_found, 'danger');
        });
}

function loadRecentActivity() {
    fetch(window.apiUrls.recentActivity)
        .then(response => response.json())
        .then(activities => {
            const limitedList = document.getElementById('recentActivityListLimited');
            const fullList = document.getElementById('recentActivityListFull');
            const limitedActivities = activities.slice(0, 2); // Show only the two most recent activities

            // Render limited view (top 2 activities)
            limitedList.innerHTML = limitedActivities.length > 0 ? limitedActivities.map(activity => `
                <div class="recent-activity-card">
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="${activity.icon} text-${activity.type}"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-description fw-semibold">${activity.description}</div>
                            <div class="activity-time text-muted">${formatTimeAgo(activity.timestamp)}</div>
                        </div>
                    </div>
                </div>
            `).join('') : `
                <div class="recent-activity-card">
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="bi bi-info-circle text-muted"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-description fw-semibold">No recent activity</div>
                            <div class="activity-time text-muted">Start by adding a budget or bill</div>
                        </div>
                    </div>
                </div>
            `;

            // Render full view (all activities)
            fullList.innerHTML = activities.length > 0 ? activities.map(activity => `
                <div class="recent-activity-card">
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="${activity.icon} text-${activity.type}"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-description fw-semibold">${activity.description}</div>
                            <div class="activity-time text-muted">${formatTimeAgo(activity.timestamp)}</div>
                        </div>
                    </div>
                </div>
            `).join('') : `
                <div class="recent-activity-card">
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="bi bi-info-circle text-muted"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-description fw-semibold">No recent activity</div>
                            <div class="activity-time text-muted">Start by adding a budget or bill</div>
                        </div>
                    </div>
                </div>
            `;
        })
        .catch(error => {
            console.error('Error loading recent activity:', error);
            const limitedList = document.getElementById('recentActivityListLimited');
            const fullList = document.getElementById('recentActivityListFull');
            limitedList.innerHTML = `
                <div class="recent-activity-card">
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="bi bi-info-circle text-muted"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-description fw-semibold">Error loading activities</div>
                            <div class="activity-time text-muted">Please try again later</div>
                        </div>
                    </div>
                </div>
            `;
            fullList.innerHTML = limitedList.innerHTML;
        });
}

function loadNotifications() {
    fetch(window.apiUrls.notifications)
        .then(response => response.json())
        .then(notifications => {
            const notificationList = document.getElementById('notificationList');
            notificationList.innerHTML = notifications.length > 0 ? notifications.map(notification => `
                <div class="notification-card">
                    <div class="notification-item">
                        <div class="notification-icon">
                            <i class="${notification.icon} text-${notification.type}"></i>
                        </div>
                        <div class="notification-content">
                            <div class="notification-description fw-semibold">${notification.message}</div>
                            <div class="notification-time text-muted">${formatTimeAgo(notification.timestamp)}</div>
                        </div>
                    </div>
                </div>
            `).join('') : `
                <div class="notification-card">
                    <div class="notification-item">
                        <div class="notification-icon">
                            <i class="bi bi-info-circle text-muted"></i>
                        </div>
                        <div class="notification-content">
                            <div class="notification-description fw-semibold">No notifications</div>
                            <div class="notification-time text-muted">Check back later</div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('notificationCount').textContent = notifications.filter(n => !n.read).length;
        })
        .catch(error => console.error('Error loading notifications:', error));
}

function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${type} border-0`;
    toast.role = 'alert';
    toast.ariaLive = 'assertive';
    toast.ariaAtomic = 'true';
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;
    document.getElementById('toastContainer')?.appendChild(toast) || document.body.appendChild(toast);
    new bootstrap.Toast(toast).show();
    setTimeout(() => toast.remove(), 5000);
}

document.addEventListener('DOMContentLoaded', function() {
    // Verify Bootstrap is loaded
    if (typeof bootstrap === 'undefined') {
        console.error('Bootstrap JavaScript is not loaded');
        showToast('Bootstrap JavaScript failed to load', 'danger');
    } else {
        console.log('Bootstrap JavaScript loaded successfully');
    }

    // Initialize modals explicitly
    const foodOrderModal = document.getElementById('foodOrderModal');
    if (foodOrderModal) {
        new bootstrap.Modal(foodOrderModal);
        console.log('Food Order Modal initialized');
    } else {
        console.error('Food Order Modal element not found');
    }

    const groceryModal = document.getElementById('groceryModal');
    if (groceryModal) {
        new bootstrap.Modal(groceryModal);
        console.log('Grocery Modal initialized');
    } else {
        console.error('Grocery Modal element not found');
    }

    // Initialize tooltips
    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(tooltipTriggerEl => {
        new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Validate Bootstrap Icons
    document.querySelectorAll('.bi').forEach(icon => {
        if (!icon.className.includes('bi-')) {
            console.warn('Invalid or missing Bootstrap Icon class:', icon.className);
        }
    });

    // Check navigation items
    const topNav = document.querySelector('.top-header');
    const bottomNav = document.querySelector('.bottom-nav');
    if (topNav && bottomNav) {
        const topNavItems = topNav.querySelectorAll('.nav-item');
        if (topNavItems.length > 0) {
            console.warn('Unexpected navigation items in top-header:', topNavItems);
        }
    }

    // Load static data
    loadFinancialSummary();
    loadRecentActivity();
    loadNotifications();

    // Initialize modules after scripts are loaded
    function initializeModules() {
        try {
            if (typeof groceryModule !== 'undefined' && typeof groceryModule.initGroceryPlanner === 'function') {
                console.log('Initializing groceryModule...');
                groceryModule.initGroceryPlanner();
                console.log('groceryModule initialized successfully');
            } else {
                console.warn('groceryModule.initGroceryPlanner is not defined');
            }
            if (typeof foodOrderModule !== 'undefined' && typeof foodOrderModule.initFoodOrder === 'function') {
                console.log('Initializing foodOrderModule...');
                foodOrderModule.initFoodOrder();
                console.log('foodOrderModule initialized successfully');
            } else {
                console.error('foodOrderModule.initFoodOrder is not defined');
                showToast('Failed to initialize Food Order feature', 'danger');
            }
        } catch (error) {
            console.error('Error initializing modules:', error);
            showToast('Error initializing application', 'danger');
        }
    }

    // Check if food-order.js is included and load it dynamically if needed
    const foodOrderScript = document.querySelector('script[src="/static/js/food-order.js"]');
    if (foodOrderScript) {
        // If script is already in the DOM, wait for it to load
        if (foodOrderScript.complete || foodOrderScript.readyState === 'loaded' || foodOrderScript.readyState === 'complete') {
            initializeModules();
        } else {
            foodOrderScript.onload = initializeModules;
            foodOrderScript.onerror = () => {
                console.error('Failed to load food-order.js');
                showToast('Failed to load Food Order script', 'danger');
            };
        }
    } else {
        // Dynamically load food-order.js
        const script = document.createElement('script');
        script.src = '/static/js/food-order.js';
        script.async = true;
        script.onload = initializeModules;
        script.onerror = () => {
            console.error('Failed to load food-order.js');
            showToast('Failed to load Food Order script', 'danger');
        };
        document.body.appendChild(script);
    }
});
</script>
{% endblock %}
